<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Misure Elettriche</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        /* Stili Generali */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to right, #e0e0e0, #ffffff);
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1300px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        header {
            background: linear-gradient(to right, #FFD700, #FFA500);
            color: black;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }

        /* Notifiche Temporanee */
        .notification {
            background-color: #DAA520; 
            color: black;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(-20px);
            margin-bottom: 10px; /* Spazio tra le notifiche se ce ne sono pi√π */
            display: inline-block; /* Per allineamento centrale e margine */
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.error {
            background-color: #dc3545; /* Rosso per errore */
        }


        .section-title {
            color: #DAA520;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        /* Layout Principale */
        .main-content {
            flex: 3;
            min-width: 600px;
        }

        .sidebar {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        /* Form di Inserimento */
        .form-section {
            background-color: #fdfdff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #DAA520;
            box-shadow: 0 0 0 3px rgba(218, 165, 32, 0.2);
            outline: none;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Bottoni */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background-color: #FFD700;
            color: black;
        }

        .btn-primary:hover {
            background-color: #DAA520;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Sezione POD */
        .pod-management {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fffacd;
            border-radius: 8px;
            border: 1px dashed #FFD700;
        }

        .pod-list {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }

        .pod-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }

        .pod-item:last-child {
            border-bottom: none;
        }

        .pod-item .btn-danger {
            padding: 5px 8px;
            font-size: 0.8em;
        }

        /* Autocomplete Suggestions */
        .suggestions-box {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 100;
            width: calc(100% - 22px);
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .suggested-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .suggested-item:hover {
            background-color: #f0f0f0;
        }
        .form-group.has-suggestions {
            position: relative;
        }

        /* Photo Upload */
        .photo-upload-area {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: border-color 0.3s;
            margin-top: 15px;
        }

        .photo-upload-area:hover {
            border-color: #DAA520;
        }

        #photoPreview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Tabella Dati */
        .data-table-container {
            overflow-x: auto;
            margin-top: 20px;
            background-color: #fdfdff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th, .data-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }

        .data-table th {
            background-color: #333;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .data-table tbody tr:hover {
            background-color: #f0f0f0;
        }

        .data-table .btn {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            margin-top: auto;
            color: #777;
            font-size: 0.9em;
            background-color: #f8f9fa;
            border-top: 1px solid #eee;
        }

        /* Stili per la visualizzazione gerarchica */
        .hierarchy-pod {
            background: #fff8dc;
            border: 1px solid #FFD700;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .hierarchy-quadro {
            background: #e0e0e0;
            border: 1px solid #a0a0a0;
            padding: 10px;
            margin-top: 10px;
            margin-left: 20px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }

        .hierarchy-interruttore {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            padding: 8px;
            margin-top: 8px;
            margin-left: 20px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .hierarchy-interruttore span strong {
            color: #4a5568;
        }
.hierarchy-legend {
    margin-top: 20px;
    padding: 10px;
    border-top: 1px solid #ccc;
    font-size: 14px;
    color: #333;
}

        /* Styles for the modal animation */
        #hierarchyModal > div {
            animation: fadeInScale 0.3s ease-out forwards;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Media Queries per la responsivit√† */
        @media (max-width: 900px) {
            .container {
                flex-direction: column;
                margin: 10px;
                padding: 15px;
            }
            .main-content, .sidebar {
                min-width: unset;
                width: 100%;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .input-group {
                flex-direction: column;
            }
            .data-table th, .data-table td {
                padding: 8px 5px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 600px) {
            header h1 {
                font-size: 1.8em;
            }
            .section-title {
                font-size: 1.2em;
            }
            .form-group input, .form-group select, .form-group textarea {
                font-size: 0.9em;
            }
            .btn {
                font-size: 0.9em;
                padding: 8px 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Dashboard Misure Elettriche</h1>
    </header>

    <div id="notificationContainer" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; width: auto; max-width: 90%; text-align: center;"></div>

    <div class="container">
        <main class="main-content">
            <section class="form-section">
                <h3 class="section-title">Inserisci Nuova Misura</h3>
                <form id="measurementForm">
                    <div class="form-group">
                        <label for="compilatoreName">Compilatore:</label>
                        <input type="text" id="compilatoreName" placeholder="Nome del compilatore" required>
                    </div>

                    <div class="form-group">
                        <label for="podSelect">POD (Point Of Delivery):</label>
                        <select id="podSelect" required>
                            <option value="">Seleziona POD...</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <div class="form-group">
                            <label for="measureDate">Data Misura:</label>
                            <input type="date" id="measureDate" required>
                        </div>
                        <div class="form-group">
                            <label for="measureTime">Ora Misura:</label>
                            <input type="time" id="measureTime" required>
                        </div>
                    </div>

                    <div class="form-group has-suggestions">
                        <label for="quadroName">Quadro:</label>
                        <input type="text" id="quadroName" placeholder="Es: QGBT-1" required autocomplete="off">
                        <div id="suggestedQuadri" class="suggestions-box" style="display: none;"></div>
                    </div>

                    <div class="form-group has-suggestions">
                        <label for="interruttore">Interruttore / Punto di Misura:</label>
                        <input type="text" id="interruttore" placeholder="Es: M1-Generale" required autocomplete="off">
                        <div id="suggestedInterruttori" class="suggestions-box" style="display: none;"></div>
                    </div>

                  <div class="form-group">
  <label>Livello Gerarchia:</label>
  <div id="hierarchyLevelsContainer" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
    <!-- I campi dinamici appariranno qui -->
  </div>
  <button type="button" id="addLevelButton" class="btn btn-primary">Aggiungi Sottolivello</button>
  <button type="button" id="removeLastLevelButton" class="btn btn-secondary" style="margin-left: 10px; display: none;">Rimuovi Ultimo Livello</button>
  <input type="hidden" id="hierarchyLevel" name="hierarchyLevel">
</div>

                    <div class="form-group">
                        <label for="voltageType">Tipo Tensione:</label>
                        <select id="voltageType" required>
                            <option value="Trifase">Trifase</option>
                            <option value="Monofase">Monofase</option>
                            <option value="Bifase">Bifase</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <div class="form-group">
                            <label for="valueR">Misura R (Ampere):</label>
                            <input type="number" step="0.1" id="valueR" placeholder="Es: 10.5" required>
                        </div>
                        <div class="form-group">
                            <label for="valueS">Misura S (Ampere):</label>
                            <input type="number" step="0.1" id="valueS" placeholder="Es: 11.2" required>
                        </div>
                        <div class="form-group">
                            <label for="valueT">Misura T (Ampere):</label>
                            <input type="number" step="0.1" id="valueT" placeholder="Es: 9.8" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="average">Corrente Media (A):</label>
                        <input type="number" step="0.1" id="average" readonly>
                    </div>

                    <div class="input-group">
                        <div class="form-group">
                            <label for="cosfi">Cos œÜ:</label>
                            <input type="number" step="0.01" id="cosfi" value="0.95" required min="0" max="1">
                        </div>
                        
                        <div class="form-group">
                            <label for="hoursYear">Ore Annuali Stimate:</label>
                            <input type="number" step="1" id="hoursYear" value="8760" required min="0" max="8760">
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="form-group">
                            <label for="power">Potenza Stimata (W):</label>
                            <input type="number" step="0.01" id="power" readonly>
                        </div>
                        <div class="form-group">
                            <label for="energy">Energia Stimata (kWh/anno):</label>
                            <input type="number" step="0.01" id="energy" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Allega Foto (max 3):</label>
                        <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                        <button type="button" class="btn btn-secondary" id="photoUpload">üì∑ Carica Foto</button>
                        <div id="photoPreview"></div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Note Aggiuntive:</label>
                        <textarea id="notes" rows="3" placeholder="Qualsiasi osservazione utile..."></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Salva Misura</button>
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn" style="display: none;">‚ùå Annulla Modifica</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
                    </div>
                </form>
            </section>
        </main>

        <aside class="sidebar">
            <div class="pod-management">
                <h3 class="section-title">Gestione POD</h3>
                <div class="input-group">
                    <div class="form-group">
                        <label for="newPod">Nuovo POD:</label>
                        <input type="text" id="newPod" placeholder="Es: POD-001">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addPod()">‚ûï Aggiungi</button>
                </div>
                <div class="input-group" style="margin-top: 10px;">    <button type="button" class="btn btn-secondary" onclick="importPodFile()">üì• Importa Anagrafica POD</button>    <input type="file" id="podFileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;"></div><div class="input-group" style="margin-top: 10px;">    <button type="button" class="btn btn-primary" onclick="generateKMZ()" id="generateKMZBtn" disabled>üó∫Ô∏è Genera KMZ</button>    <button type="button" class="btn btn-secondary" onclick="showCoordinatesTable()">üìç Mostra Coordinate</button></div>
                <div class="pod-list" id="podList">
                </div>
            </div>
<div class="data-viewer">
    <h3 class="section-title">Azioni</h3>

    <button class="btn btn-secondary" onclick="exportCSV()">üìä Esporta CSV</button>
    <button class="btn btn-secondary" onclick="exportWithPhotos()">üìä Esporta CSV + Foto</button>
    <button class="btn btn-primary" onclick="importCSV()">üì• Importa CSV</button>
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
    <button class="btn btn-secondary" onclick="showHierarchy()">üå≥ Mostra Gerarchia</button>
    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Cancella Tutti i Dati</button>

    <div style="margin-top: 20px; font-weight: bold; font-size: 1.1em; color: #4CAF50;">
        Misure salvate: <span id="dataCount">0</span>
    </div>
</div>
        </aside>
    </div>

    <div class="data-table-container">
        <h3 class="section-title">Misure Salvate</h3>
        <table class="data-table" id="dataTable">
            <thead>
                <tr>
                    <th>Compilatore</th> <th>POD</th>
                    <th>Data/Ora</th>
                    <th>Livello Gerarchia</th>
                    <th>Quadro</th>
                    <th>Punto di Misura</th>
                    <th>Mis. R-S-T (A)</th>
                    <th>Media (A)</th>
                    <th>Cos œÜ</th>
                    <th>Tipo/Livello Tensione</th>
                    <th>Potenza (W)</th>
                    <th>Energia (kWh/anno)</th>
                    <th>Foto</th>
                    <th>Note</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="hierarchyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">
            <h3 class="section-title">Schema Gerarchico Impianto</h3>
            <div id="hierarchyTree" style="padding-top: 10px;">
                </div>
            <button class="btn btn-secondary" onclick="hideHierarchy()" style="margin-top: 20px;">Chiudi</button>
        </div>
    </div>
<div id="coordinatesModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; justify-content: center; align-items: center;">    <div style="background: white; padding: 30px; border-radius: 15px; max-width: 90%; max-height: 90%; overflow: auto; position: relative;">        <h3 class="section-title">Coordinate POD Caricate</h3>        <div id="coordinatesTableContainer" style="padding-top: 10px; max-height: 400px; overflow-y: auto;">            <table class="data-table" id="coordinatesTable">                <thead>                    <tr>                        <th>POD</th>                        <th>Denominazione</th>                        <th>Latitudine</th>                        <th>Longitudine</th>                        <th>Comune</th>                        <th>Indirizzo</th>                    </tr>                </thead>                <tbody></tbody>            </table>        </div>        <div style="margin-top: 20px;">            <button class="btn btn-primary" onclick="generateKMZ()" style="margin-right: 10px;">üó∫Ô∏è Genera KMZ</button>            <button class="btn btn-secondary" onclick="hideCoordinatesTable()">Chiudi</button>        </div>    </div></div>
    <footer>
        <p>&copy; 2025 Dashboard Misure Elettriche. Tutti i diritti riservati.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Variabili globali per memorizzare i dati
        let measurements = JSON.parse(localStorage.getItem('measurements') || '[]');
        let pods = JSON.parse(localStorage.getItem('pods') || '[]');
        let quadroNames = JSON.parse(localStorage.getItem('quadroNames') || '[]');
        let interruttoreNames = JSON.parse(localStorage.getItem('interruttoreNames') || '[]');
        let editingId = null; // ID della misura in fase di modifica
        let photoFiles = []; // Array per memorizzare i file foto (come base64)
        let podCoordinates = []; // Array per memorizzare le coordinate dei POD

        // Funzione eseguita al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            loadPods();
            updateDataTable();
            updateDataCount();
            // Imposta data e ora correnti come predefiniti
            const now = new Date();
            document.getElementById('measureDate').value = now.toISOString().split('T')[0];
            document.getElementById('measureTime').value = now.toTimeString().slice(0, 5);
            setupEventListeners();
            // Configura tutti gli event listener
            handleVoltageTypeChange(); // Ensure initial state of S and T fields is correct
            updateHierarchyDisplay(); // Aggiorna la gerarchia iniziale
            loadCoordinates(); // Carica le coordinate salvate all'avvio
        });

function setupHierarchyInput() {
  const container = document.getElementById('hierarchyLevelsContainer');
  const addBtn = document.getElementById('addLevelButton');
  const removeBtn = document.getElementById('removeLastLevelButton');
  const hiddenInput = document.getElementById('hierarchyLevel');

  function updateHiddenHierarchy() {
    const inputs = container.querySelectorAll('input');
    const values = Array.from(inputs).map(input => input.value.trim()).filter(v => v !== '');
    hiddenInput.value = values.join('.');
    removeBtn.style.display = inputs.length > 1 ? 'inline-block' : 'none';
  }

function addLevel(value = '') {
  const input = document.createElement('input');
  input.type = 'number'; // CAMBIA da 'text' a 'number'
  input.step = '1';       // Incremento unitario
  input.min = '0';        // (Opzionale) limite minimo
  input.placeholder = `Livello ${container.children.length + 1}`;
  input.className = 'form-control';
  input.value = value;
  input.style.padding = '8px';
  input.style.borderRadius = '6px';
  input.style.border = '1px solid #ccc';
  input.addEventListener('input', updateHiddenHierarchy);
  container.appendChild(input);
  updateHiddenHierarchy();
}

  function removeLastLevel() {
    const inputs = container.querySelectorAll('input');
    if (inputs.length > 1) {
      container.removeChild(inputs[inputs.length - 1]);
      updateHiddenHierarchy();
    }
  }

  addBtn.addEventListener('click', () => addLevel());
  removeBtn.addEventListener('click', removeLastLevel);

  // Inizializza con 1 livello
  addLevel();
}

document.addEventListener('DOMContentLoaded', function () {
  setupHierarchyInput();
});


        // Funzione per aprire il dialog di selezione file CSV
        function importCSV() {
            document.getElementById('csvFileInput').click();
        }

        // Funzione per processare il file CSV caricato
        function processCSVFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showNotification('Per favore seleziona un file CSV valido.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    parseAndImportCSV(csvContent);
                } catch (error) {
                    showNotification('Errore nella lettura del file CSV: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            // Reset del campo file
            event.target.value = '';
        }

        // Funzione per parsare e importare i dati CSV
        function parseAndImportCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                showNotification('Il file CSV √® vuoto o non contiene dati validi.', 'error');
                return;
            }

            const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
            const expectedHeaders = [
                "ID", "Compilatore", "POD", "Data Misura", "Ora Misura", "Quadro",
                "Interruttore/Punto", "Livello Gerarchia", "Misura R (A)", "Misura S (A)",
                "Misura T (A)", "Media (A)", "Cos œÜ", "Tipo Tensione", "Valore Tensione Usato (V)",
                "Ore/Anno", "Potenza (W)", "Energia Stimata (kWh/anno)", "Note"
            ];

            // Verifica che gli header corrispondano
            const headersMatch = expectedHeaders.every(header => headers.includes(header));
            if (!headersMatch) {
                showNotification('Il formato del file CSV non corrisponde a quello atteso. Verifica che sia stato esportato da questa applicazione.', 'error');
                return;
            }

            let importedCount = 0;
            let errorCount = 0;
            const newMeasurements = [];
            const importedPods = new Set();

            // Processa ogni riga di dati
            for (let i = 1; i < lines.length; i++) {
                try {
                    const values = parseCSVLine(lines[i]);
                    if (values.length !== headers.length) {
                        console.warn(`Riga ${i + 1}: numero di colonne non corrispondente`);
                        errorCount++;
                        continue;
                    }

                    const measurement = {};
                    headers.forEach((header, index) => {
                        measurement[header] = values[index];
                    });

                    // Converte e valida i dati
                    const processedMeasurement = {
                        id: parseInt(measurement["ID"]) || Date.now() + Math.random(), // Genera nuovo ID se non valido
                        compilatoreName: measurement["Compilatore"]?.trim() || '', // Nuovo campo
                        pod: measurement["POD"]?.trim() || '',
                        measureDate: measurement["Data Misura"]?.trim() || '',
                        measureTime: measurement["Ora Misura"]?.trim() || '',
                        quadroName: measurement["Quadro"]?.trim() || '',
                        interruttore: measurement["Interruttore/Punto"]?.trim() || '',
                        hierarchyLevel: measurement["Livello Gerarchia"]?.trim() || '',
                        valueR: parseFloat(measurement["Misura R (A)"]) || 0,
                        valueS: parseFloat(measurement["Misura S (A)"]) || 0,
                        valueT: parseFloat(measurement["Misura T (A)"]) || 0,
                        average: parseFloat(measurement["Media (A)"]) || 0,
                        cosfi: parseFloat(measurement["Cos œÜ"]) || 0.9,
                        voltageType: measurement["Tipo Tensione"]?.trim() || 'Trifase',
                        voltageValueUsed: parseFloat(measurement["Valore Tensione Usato (V)"]) || 400,
                        hoursYear: parseInt(measurement["Ore/Anno"]) || 8760,
                        power: parseFloat(measurement["Potenza (W)"]) || 0,
                        energy: parseFloat(measurement["Energia Stimata (kWh/anno)"]) || 0,
                        photos: [], // Le foto non possono essere importate da CSV
                        notes: measurement["Note"]?.replace(/"/g, '').trim() || ''
                    };

                    // Validazione base
                    if (!processedMeasurement.pod || !processedMeasurement.measureDate || !processedMeasurement.quadroName || !processedMeasurement.interruttore) {
                        console.warn(`Riga ${i + 1}: dati obbligatori mancanti`);
                        errorCount++;
                        continue;
                    }

                    newMeasurements.push(processedMeasurement);
                    importedPods.add(processedMeasurement.pod);

                    // Aggiungi ai suggerimenti se non esistono gi√†
                    if (!quadroNames.includes(processedMeasurement.quadroName)) {
                        quadroNames.push(processedMeasurement.quadroName);
                    }
                    if (!interruttoreNames.includes(processedMeasurement.interruttore)) {
                        interruttoreNames.push(processedMeasurement.interruttore);
                    }
                    importedCount++;

                } catch (error) {
                    console.error(`Errore processando riga ${i + 1}:`, error);
                    errorCount++;
                }
            }

            if (importedCount === 0) {
                showNotification('Nessun dato valido trovato nel file CSV.', 'error');
                return;
            }

            // Conferma prima dell'importazione
            const confirmMessage = `Trovate ${importedCount} misure valide da importare${errorCount > 0 ? ` (${errorCount} righe con errori ignorate)` : ''}.\n\nVuoi:\n- SOSTITUIRE tutti i dati esistenti\n- AGGIUNGERE ai dati esistenti\n\nClicca OK per SOSTITUIRE, Annulla per AGGIUNGERE.`;
            const replace = confirm(confirmMessage);

            if (replace) {
                // Sostituisce tutti i dati
                measurements = newMeasurements;
                pods = Array.from(importedPods);
            } else {
                // Aggiunge ai dati esistenti
                // Controlla per evitare duplicati basati su ID
                const existingIds = new Set(measurements.map(m => m.id));
                const uniqueNewMeasurements = newMeasurements.filter(m => !existingIds.has(m.id));
                measurements = measurements.concat(uniqueNewMeasurements);

                // Aggiunge nuovi POD
                importedPods.forEach(pod => {
                    if (!pods.includes(pod)) {
                        pods.push(pod);
                    }
                });
                importedCount = uniqueNewMeasurements.length;
            }

            // Salva tutto in localStorage
            localStorage.setItem('measurements', JSON.stringify(measurements));
            localStorage.setItem('pods', JSON.stringify(pods));
            localStorage.setItem('quadroNames', JSON.stringify(quadroNames));
            localStorage.setItem('interruttoreNames', JSON.stringify(interruttoreNames));

            // Aggiorna l'interfaccia
            loadPods();
            updateDataTable();
            updateDataCount();

            // Notifica il risultato
            let message = `Importazione completata! ${importedCount} misure importate.`;
            if (errorCount > 0) {
                message += ` ${errorCount} righe ignorate per errori.`;
            }
            showNotification(message);
        }

        // Funzione helper per parsare una riga CSV gestendo le virgolette
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ';' && !inQuotes) {
                    result.push(current.replace(/^"|"$/g, '')); // Rimuove le virgolette esterne
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.replace(/^"|"$/g, ''));
            return result;
        }

        // Funzione per esportare i dati in formato CSV
        function exportCSV() {
            if (measurements.length === 0) {
                showNotification('Nessun dato da esportare.', 'info');
                return;
            }

            const headers = [
                "ID", "Compilatore", "POD", "Data Misura", "Ora Misura", "Quadro",
                "Interruttore/Punto", "Livello Gerarchia", "Misura R (A)", "Misura S (A)",
                "Misura T (A)", "Media (A)", "Cos œÜ", "Tipo Tensione", "Valore Tensione Usato (V)",
                "Ore/Anno", "Potenza (W)", "Energia Stimata (kWh/anno)", "Note"
            ];

            let csvContent = headers.map(header => `"${header}"`).join(';') + '\n'; // Aggiungi virgolette agli header

            measurements.forEach(m => {
                const row = [
                    m.id,
                    `"${(m.compilatoreName || '').replace(/"/g, '""')}"`, // Gestisci virgolette doppie
                    `"${(m.pod || '').replace(/"/g, '""')}"`,
                    `"${(m.measureDate || '').replace(/"/g, '""')}"`,
                    `"${(m.measureTime || '').replace(/"/g, '""')}"`,
                    `"${(m.quadroName || '').replace(/"/g, '""')}"`,
                    `"${(m.interruttore || '').replace(/"/g, '""')}"`,
                    `"${(m.hierarchyLevel || '').replace(/"/g, '""')}"`,
                    (m.valueR || 0).toFixed(2).replace('.', ','), // Usa virgola come separatore decimale
                    (m.valueS || 0).toFixed(2).replace('.', ','),
                    (m.valueT || 0).toFixed(2).replace('.', ','),
                    (m.average || 0).toFixed(2).replace('.', ','),
                    (m.cosfi || 0).toFixed(2).replace('.', ','),
                    `"${(m.voltageType || '').replace(/"/g, '""')}"`,
                    (m.voltageValueUsed || 0).toFixed(0).replace('.', ','),
                    (m.hoursYear || 0),
                    (m.power || 0).toFixed(2).replace('.', ','),
                    (m.energy || 0).toFixed(2).replace('.', ','),
                    `"${(m.notes || '').replace(/"/g, '""')}"`
                ];
                csvContent += row.join(';') + '\n';
            });

           const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const fileName = `misure_elettriche_${timestamp}.csv`;
downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');
            showNotification('Dati esportati con successo in CSV!');
        }

        // Funzione per esportare CSV con foto
        function exportWithPhotos() {
            if (measurements.length === 0) {
                showNotification('Nessun dato da esportare.', 'info');
                return;
            }

            const headers = [
                "ID", "Compilatore", "POD", "Data Misura", "Ora Misura", "Quadro",
                "Interruttore/Punto", "Livello Gerarchia", "Misura R (A)", "Misura S (A)",
                "Misura T (A)", "Media (A)", "Cos œÜ", "Tipo Tensione", "Valore Tensione Usato (V)",
                "Ore/Anno", "Potenza (W)", "Energia Stimata (kWh/anno)", "Note", "Foto_Base64_1", "Foto_Base64_2", "Foto_Base64_3"
            ];

            let csvContent = headers.map(header => `"${header}"`).join(';') + '\n';

            measurements.forEach(m => {
                const photosBase64 = m.photos.map(photo => `"${photo.base64.replace(/"/g, '""')}"`);
                while (photosBase64.length < 3) {
                    photosBase64.push('""'); // Assicurati che ci siano sempre 3 colonne per le foto
                }

                const row = [
                    m.id,
                    `"${(m.compilatoreName || '').replace(/"/g, '""')}"`,
                    `"${(m.pod || '').replace(/"/g, '""')}"`,
                    `"${(m.measureDate || '').replace(/"/g, '""')}"`,
                    `"${(m.measureTime || '').replace(/"/g, '""')}"`,
                    `"${(m.quadroName || '').replace(/"/g, '""')}"`,
                    `"${(m.interruttore || '').replace(/"/g, '""')}"`,
                    `"${(m.hierarchyLevel || '').replace(/"/g, '""')}"`,
                    (m.valueR || 0).toFixed(2).replace('.', ','),
                    (m.valueS || 0).toFixed(2).replace('.', ','),
                    (m.valueT || 0).toFixed(2).replace('.', ','),
                    (m.average || 0).toFixed(2).replace('.', ','),
                    (m.cosfi || 0).toFixed(2).replace('.', ','),
                    `"${(m.voltageType || '').replace(/"/g, '""')}"`,
                    (m.voltageValueUsed || 0).toFixed(0).replace('.', ','),
                    (m.hoursYear || 0),
                    (m.power || 0).toFixed(2).replace('.', ','),
                    (m.energy || 0).toFixed(2).replace('.', ','),
                    `"${(m.notes || '').replace(/"/g, '""')}"`,
                    ...photosBase64
                ];
                csvContent += row.join(';') + '\n';
            });

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
const fileName = `misure_elettriche_con_foto_${timestamp}.csv`;
downloadFile(csvContent, fileName, 'text/csv;charset=utf-8;');

            showNotification('Dati con foto esportati con successo in CSV!');
        }

        // Funzione helper per il download di file
        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Funzione per resettare il form
        function resetForm() {
            document.getElementById('measurementForm').reset();
            document.getElementById('saveBtn').textContent = 'üíæ Salva Misura';
            document.getElementById('cancelEditBtn').style.display = 'none';
            editingId = null;
            photoFiles = [];
            document.getElementById('photoPreview').innerHTML = '';
            // Reimposta data e ora correnti
            const now = new Date();
            document.getElementById('measureDate').value = now.toISOString().split('T')[0];
            document.getElementById('measureTime').value = now.toTimeString().slice(0, 5);
            updateHierarchyDisplay();
            showNotification('Form resettato.');
        }

        // Funzione per eliminare tutti i dati
        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare TUTTI i dati salvati? Questa azione √® irreversibile.')) {
                measurements = [];
                pods = [];
                quadroNames = [];
                interruttoreNames = [];
                podCoordinates = []; // Clear coordinates as well
                localStorage.clear(); // Cancella tutto il localStorage
                updateDataTable();
                updateDataCount();
                loadPods();
                updateKMZButtonState(); // Update KMZ button state
                showNotification('Tutti i dati sono stati cancellati.');
            }
        }

        // Funzioni per la gestione dei POD
        function addPod() {
            const newPodInput = document.getElementById('newPod');
            const newPodValue = newPodInput.value.trim().toUpperCase(); // Converti in maiuscolo
            if (newPodValue && !pods.includes(newPodValue)) {
                pods.push(newPodValue);
                localStorage.setItem('pods', JSON.stringify(pods));
                loadPods();
                newPodInput.value = '';
                showNotification(`POD "${newPodValue}" aggiunto.`);
            } else if (newPodValue) {
                showNotification(`POD "${newPodValue}" esiste gi√†.`, 'info');
            }
        }

        function removePod(podToRemove) {
            if (confirm(`Sei sicuro di voler rimuovere il POD "${podToRemove}"? Tutte le misure associate a questo POD rimarranno, ma il POD non sar√† pi√π selezionabile.`)) {
                pods = pods.filter(pod => pod !== podToRemove);
                localStorage.setItem('pods', JSON.stringify(pods));
                loadPods();
                // Rimuovi anche le coordinate associate a quel POD
                podCoordinates = podCoordinates.filter(coord => coord.pod !== podToRemove);
                localStorage.setItem('podCoordinates', JSON.stringify(podCoordinates));
                updateKMZButtonState();
                showNotification(`POD "${podToRemove}" rimosso.`);
            }
        }

        function loadPods() {
            const podSelect = document.getElementById('podSelect');
            podSelect.innerHTML = '<option value="">Seleziona POD...</option>';
            pods.sort().forEach(pod => { // Ordina i POD alfabeticamente
                const option = document.createElement('option');
                option.value = pod;
                option.textContent = pod;
                podSelect.appendChild(option);
            });

            const podList = document.getElementById('podList');
            podList.innerHTML = '';
            if (pods.length === 0) {
                podList.innerHTML = '<p style="text-align: center; color: #777; margin-top: 20px;">Nessun POD aggiunto.</p>';
            } else {
                pods.forEach(pod => {
                    const podItem = document.createElement('div');
                    podItem.className = 'pod-item';
                    podItem.innerHTML = `
                        <span>${pod}</span>
                        <button type="button" class="btn btn-danger" onclick="removePod('${pod}')">üóëÔ∏è</button>
                    `;
                    podList.appendChild(podItem);
                });
            }
        }

        // Funzione per gestire il caricamento del file POD
        function importPodFile() {
            document.getElementById('podFileInput').click();
        }

        // Listener per il cambiamento del file di input POD
        document.getElementById('podFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        parseAndImportPodCSV(new TextDecoder('utf-8').decode(data));
                    } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                        parseAndImportPodXLSX(data);
                    } else {
                        showNotification('Formato file non supportato. Si prega di caricare un file CSV o XLSX.', 'error');
                    }
                } catch (error) {
                    showNotification('Errore nella lettura del file: ' + error.message, 'error');
                    console.error('Errore lettura file POD:', error);
                }
            };

            if (file.name.toLowerCase().endsWith('.csv')) {
                reader.readAsArrayBuffer(file);
            } else if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            }
            event.target.value = ''; // Reset the input so same file can be selected again
        });

        // Funzione per parsare e importare i dati POD da CSV
        function parseAndImportPodCSV(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                showNotification('Il file CSV dell\'anagrafica POD √® vuoto o non contiene dati validi.', 'error');
                return;
            }

            const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
            const podColIndex = headers.findIndex(h => h === "POD" || h === "POD14");
            const denominazioneColIndex = headers.findIndex(h => h === "DENOMINAZIONE UTENZA");

            if (podColIndex === -1 || denominazioneColIndex === -1) {
                showNotification('Il file CSV dell\'anagrafica POD deve contenere le colonne "POD" e "DENOMINAZIONE UTENZA".', 'error');
                return;
            }

            let importedCount = 0;
            let errorCount = 0;
            const newPodsSet = new Set(pods); // Usa un Set per l'efficienza nella verifica di esistenza

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length > Math.max(podColIndex, denominazioneColIndex)) {
                    const podValue = (values[podColIndex] || '').trim();
                    const denominazioneValue = (values[denominazioneColIndex] || '').trim();

                    if (podValue && denominazioneValue) {
                        const combinedPod = `${podValue}-${denominazioneValue}`;
                        if (!newPodsSet.has(combinedPod)) {
                            newPodsSet.add(combinedPod);
                            importedCount++;
                        }
                    } else {
                        errorCount++;
                    }
                } else {
                    errorCount++;
                }
            }
            handlePodImportResults(importedCount, errorCount, newPodsSet, 'CSV');
        }

        // Function to parse and import POD data from XLSX (with coordinates support)
function parseAndImportPodXLSX(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0]; 
    const worksheet = workbook.Sheets[sheetName];
        
const jsonData = XLSX.utils.sheet_to_json(worksheet, {
    raw: false, // <--- legge le celle come visibili, con tutti i decimali
    header: 1
});

    if (jsonData.length < 2) {
        showNotification('Il file XLSX dell\'anagrafica POD √® vuoto o non contiene dati validi.', 'error');
        return;
    }

    const headers = jsonData[0].map(h => typeof h === 'string' ? h.trim() : '');

    // Trova gli indici delle colonne necessarie
    const podColIndex = headers.findIndex(h => h === "POD" || h === "POD14");
    const denominazioneColIndex = headers.findIndex(h => h === "DENOMINAZIONE UTENZA" || h === "DENOMINAZIONE UTENZE");
    const latColIndex = headers.findIndex(h => 
        h.includes("LAT") || h.includes("LATITUDINE") || h === "Y" || h === "NORD"
    );
    const lonColIndex = headers.findIndex(h => 
        h.includes("LON") || h.includes("LONGITUDINE") || h === "X" || h === "EST"
    );
    const comuneColIndex = headers.findIndex(h => 
        h.includes("COMUNE") || h.includes("CITY") || h.includes("CITTA") || h.includes("LOCALITA")
    );
    const indirizzoColIndex = headers.findIndex(h => 
        h.includes("INDIRIZZO") || h.includes("ADDRESS") || h.includes("VIA")
    );

    if (podColIndex === -1 || denominazioneColIndex === -1) {
        showNotification('Il file XLSX dell\'anagrafica POD deve contenere le colonne "POD" e "DENOMINAZIONE UTENZA".', 'error');
        return;
    }

    let importedCount = 0;
    let errorCount = 0;
    let coordinatesCount = 0;
    const newPodsSet = new Set(pods);
    const newCoordinates = [];

    for (let i = 1; i < jsonData.length; i++) {
        const row = jsonData[i];
        if (!row) {
            errorCount++;
            continue;
        }

        try {
            const podValue = (typeof row[podColIndex] === 'string' ? row[podColIndex].trim() : String(row[podColIndex] || '')).trim();
            const denominazioneValue = (typeof row[denominazioneColIndex] === 'string' ? row[denominazioneColIndex].trim() : String(row[denominazioneColIndex] || '')).trim();

            if (podValue && denominazioneValue) {
                const combinedPod = `${podValue}-${denominazioneValue}`;
                if (!newPodsSet.has(combinedPod)) {
                    newPodsSet.add(combinedPod);
                    importedCount++;
                }

                // Estrai le coordinate se disponibili
                let lat = null, lon = null;
                if (latColIndex !== -1 && lonColIndex !== -1) {
                    const latValue = row[latColIndex];
                    const lonValue = row[lonColIndex];
                                        
                    if (latValue && lonValue) {
                        lat = parseFloat(String(latValue).replace(',', '.'));
                        lon = parseFloat(String(lonValue).replace(',', '.'));
                                                
                        // Verifica che le coordinate siano valide (range Italia approssimativo)
                        if (!isNaN(lat) && !isNaN(lon) && 
                            lat >= 35 && lat <= 48 && 
                            lon >= 6 && lon <= 19) {
                            coordinatesCount++;
                        } else {
                            lat = null;
                            lon = null;
                        }
                    }
                }

                // Aggiungi alle coordinate se valide
                if (lat && lon) {
                    newCoordinates.push({
                        pod: podValue,
                        denominazione: denominazioneValue,
                        combinedPod: combinedPod,
                        lat: lat,
                        lon: lon,
                        comune: comuneColIndex !== -1 ? (row[comuneColIndex] || '').toString().trim() : '',
                        indirizzo: indirizzoColIndex !== -1 ? (row[indirizzoColIndex] || '').toString().trim() : ''
                    });
                }
            } else {
                console.warn(`Riga ${i + 1} (XLSX): dati POD o DENOMINAZIONE UTENZA mancanti.`);
                errorCount++;
            }
        } catch (error) {
            console.error(`Errore processando riga ${i + 1} del file POD (XLSX):`, error);
            errorCount++;
        }
    }
    handlePodImportResults(importedCount, errorCount, newPodsSet, 'XLSX', newCoordinates, coordinatesCount);
}

// Helper function to handle the results of POD import (updated for coordinates)
function handlePodImportResults(importedCount, errorCount, newPodsSet, fileType, coordinates = [], coordinatesCount = 0) {
    if (importedCount === 0 && errorCount > 0) { 
        showNotification(`Nessun nuovo POD importato. ${errorCount} righe con errori o dati mancanti nel file ${fileType}.`, 'error'); 
        return;
    } else if (importedCount === 0 && errorCount === 0) {
        showNotification(`Nessun nuovo POD importato dal file ${fileType}. Tutti i POD nel file esistono gi√†.`, 'success');
        return;
    }

    let confirmMessage = `Trovati ${importedCount} nuovi POD unici da importare dal file ${fileType}`;
    if (coordinatesCount > 0) {
        confirmMessage += ` (${coordinatesCount} con coordinate valide)`;
    }
    confirmMessage += `${errorCount > 0 ? ` (${errorCount} righe con errori ignorate)` : ''}.\n\nVuoi AGGIUNGERE questi POD a quelli esistenti?`;
        
    if (confirm(confirmMessage)) {
        pods = Array.from(newPodsSet);
                
        // Aggiorna le coordinate
        if (coordinates.length > 0) {
            // Rimuovi eventuali coordinate esistenti per gli stessi POD
            const newPodSet = new Set(coordinates.map(c => c.combinedPod));
            podCoordinates = podCoordinates.filter(c => !newPodSet.has(c.combinedPod));
            // Aggiungi le nuove coordinate
            podCoordinates = podCoordinates.concat(coordinates);
            localStorage.setItem('podCoordinates', JSON.stringify(podCoordinates));
        }
                
        localStorage.setItem('pods', JSON.stringify(pods));
        loadPods();
        updateKMZButtonState();
                
        let message = `Importazione Anagrafica POD da ${fileType} completata! Aggiunti ${importedCount} nuovi POD.`;
        if (coordinatesCount > 0) {
            message += ` Caricate ${coordinatesCount} coordinate.`;
        }
        showNotification(message);
    } else {
        showNotification('Importazione Anagrafica POD annullata.', 'info');
    }
}
        // Funzione per aggiornare la tabella delle misure
        function updateDataTable() {
            const dataTableBody = document.querySelector('#dataTable tbody');
            dataTableBody.innerHTML = ''; // Pulisci la tabella esistente

            // Ordina le misure dalla pi√π recente alla meno recente
            const sortedMeasurements = [...measurements].sort((a, b) => {
                const dateTimeA = new Date(`${a.measureDate}T${a.measureTime}`);
                const dateTimeB = new Date(`${b.measureDate}T${b.measureTime}`);
                return dateTimeB - dateTimeA;
            });

            sortedMeasurements.forEach(measure => {
                const row = dataTableBody.insertRow();
                row.setAttribute('data-id', measure.id); // Aggiungi un attributo data-id per riferimento
                row.insertCell().textContent = measure.compilatoreName; // Nuovo campo compilatore
                row.insertCell().textContent = measure.pod;
                row.insertCell().textContent = `${measure.measureDate} ${measure.measureTime}`;
                row.insertCell().textContent = measure.hierarchyLevel;
                row.insertCell().textContent = measure.quadroName;
                row.insertCell().textContent = measure.interruttore;
                row.insertCell().textContent = `${(measure.valueR || 0).toFixed(2)} / ${(measure.valueS || 0).toFixed(2)} / ${(measure.valueT || 0).toFixed(2)}`;
                row.insertCell().textContent = (measure.average || 0).toFixed(2);
                row.insertCell().textContent = (measure.cosfi || 0).toFixed(2);
                row.insertCell().textContent = `${measure.voltageType} (${measure.voltageValueUsed}V)`;
                row.insertCell().textContent = (measure.power || 0).toFixed(2);
                row.insertCell().textContent = (measure.energy || 0).toFixed(2);

                const photoCell = row.insertCell();
                if (measure.photos && measure.photos.length > 0) {
                    measure.photos.forEach((photo, index) => {
                        const img = document.createElement('img');
                        img.src = photo.base64;
                        img.alt = `Foto ${index + 1}`;
                        img.style.width = '50px';
                        img.style.height = '50px';
                        img.style.objectFit = 'cover';
                        img.style.marginRight = '5px';
                        img.style.cursor = 'pointer';
                        img.onclick = () => {
                            const newWindow = window.open();
                            newWindow.document.body.innerHTML = `<img src="${photo.base64}" style="max-width: 100%; height: auto;">`;
                        };
                        photoCell.appendChild(img);
                    });
                } else {
                    photoCell.textContent = 'N/A';
                }

                row.insertCell().textContent = measure.notes;

                const actionsCell = row.insertCell();
                const editButton = document.createElement('button');
                editButton.textContent = '‚úèÔ∏è Modifica';
                editButton.className = 'btn btn-secondary';
                editButton.onclick = () => editMeasurement(measure.id);
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'üóëÔ∏è Elimina';
                deleteButton.className = 'btn btn-danger';
                deleteButton.style.marginLeft = '5px';
                deleteButton.onclick = () => deleteMeasurement(measure.id);
                actionsCell.appendChild(deleteButton);
            });
        }

        // Funzione per aggiornare il conteggio dei dati
        function updateDataCount() {
            document.getElementById('dataCount').textContent = measurements.length;
        }

        // Funzione per salvare o aggiornare una misura
        document.getElementById('measurementForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const compilatoreName = document.getElementById('compilatoreName').value;
            const pod = document.getElementById('podSelect').value;
            const measureDate = document.getElementById('measureDate').value;
            const measureTime = document.getElementById('measureTime').value;
            const quadroName = document.getElementById('quadroName').value;
            const interruttore = document.getElementById('interruttore').value;
            const hierarchyLevel = document.getElementById('hierarchyLevel').value;
            const voltageType = document.getElementById('voltageType').value;
            const valueR = parseFloat(document.getElementById('valueR').value);
            const valueS = parseFloat(document.getElementById('valueS').value);
            const valueT = parseFloat(document.getElementById('valueT').value);
            const cosfi = parseFloat(document.getElementById('cosfi').value);
            const hoursYear = parseInt(document.getElementById('hoursYear').value);
            const notes = document.getElementById('notes').value;

            // Calcoli
            const average = calculateAverage(valueR, valueS, valueT);
            const voltageValueUsed = (voltageType === 'Trifase') ? 400 : 230;
            const power = calculatePower(average, cosfi, voltageType, voltageValueUsed);
            const energy = calculateEnergy(power, hoursYear);

            const newMeasurement = {
                id: editingId || Date.now(), // Usa l'ID esistente se in modifica, altrimenti crea nuovo
                compilatoreName, // Includi il nome del compilatore
                pod,
                measureDate,
                measureTime,
                quadroName,
                interruttore,
                hierarchyLevel,
                valueR,
                valueS,
                valueT,
                average,
                cosfi,
                voltageType,
                voltageValueUsed,
                hoursYear,
                power,
                energy,
                photos: photoFiles, // Salva le foto in base64
                notes
            };
if (!editingId) {
    const isDuplicate = measurements.some(m =>
        m.pod === pod &&

        m.hierarchyLevel === hierarchyLevel
    );

    if (isDuplicate) {
        showNotification("‚ùå Esiste gi√† una misura con lo stesso POD e Livello Gerarchico.", "error");
        return; // blocca il salvataggio
    }
}
            if (editingId) {
                // Modifica misura esistente
                measurements = measurements.map(m => m.id === editingId ? newMeasurement : m);
                showNotification('Misura aggiornata con successo!');
            } else {
                // Aggiungi nuova misura
                measurements.push(newMeasurement);
                showNotification('Misura salvata con successo!');
            }

            // Aggiorna suggerimenti
            if (!quadroNames.includes(quadroName)) {
                quadroNames.push(quadroName);
                localStorage.setItem('quadroNames', JSON.stringify(quadroNames));
            }
            if (!interruttoreNames.includes(interruttore)) {
                interruttoreNames.push(interruttore);
                localStorage.setItem('interruttoreNames', JSON.stringify(interruttoreNames));
            }

            localStorage.setItem('measurements', JSON.stringify(measurements));
           // resetForm(); // Resetta il form dopo il salvataggio
            updateDataTable(); // Aggiorna la tabella
            updateDataCount(); // Aggiorna il conteggio
        });

        // Funzione per modificare una misura esistente
        function editMeasurement(id) {
            const measure = measurements.find(m => m.id === id);
            if (measure) {
                editingId = id;
                document.getElementById('compilatoreName').value = measure.compilatoreName;
                document.getElementById('podSelect').value = measure.pod;
                document.getElementById('measureDate').value = measure.measureDate;
                document.getElementById('measureTime').value = measure.measureTime;
                document.getElementById('quadroName').value = measure.quadroName;
                document.getElementById('interruttore').value = measure.interruttore;
                document.getElementById('hierarchyLevel').value = measure.hierarchyLevel;
                document.getElementById('voltageType').value = measure.voltageType;
                document.getElementById('valueR').value = measure.valueR;
                document.getElementById('valueS').value = measure.valueS;
                document.getElementById('valueT').value = measure.valueT;
                document.getElementById('cosfi').value = measure.cosfi;
                document.getElementById('hoursYear').value = measure.hoursYear;
                document.getElementById('notes').value = measure.notes;

                // Aggiorna i campi calcolati
                document.getElementById('average').value = measure.average.toFixed(2);
                document.getElementById('power').value = measure.power.toFixed(2);
                document.getElementById('energy').value = measure.energy.toFixed(2);

                // Carica le foto per la modifica
                photoFiles = [...measure.photos];
                renderPhotoPreview();

                document.getElementById('saveBtn').textContent = '‚úÖ Aggiorna Misura';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';

                showNotification('Modifica misura ID: ' + id);
            }
        }

        // Funzione per eliminare una misura
        function deleteMeasurement(id) {
            if (confirm('Sei sicuro di voler eliminare questa misura?')) {
                measurements = measurements.filter(m => m.id !== id);
                localStorage.setItem('measurements', JSON.stringify(measurements));
                updateDataTable();
                updateDataCount();
                showNotification('Misura eliminata con successo.');
            }
        }

        // Calcoli automatici
        document.getElementById('valueR').addEventListener('input', updateCalculations);
        document.getElementById('valueS').addEventListener('input', updateCalculations);
        document.getElementById('valueT').addEventListener('input', updateCalculations);
        document.getElementById('cosfi').addEventListener('input', updateCalculations);
        document.getElementById('hoursYear').addEventListener('input', updateCalculations);
        document.getElementById('voltageType').addEventListener('change', handleVoltageTypeChange);

        function updateCalculations() {
            const valueR = parseFloat(document.getElementById('valueR').value) || 0;
            const valueS = parseFloat(document.getElementById('valueS').value) || 0;
            const valueT = parseFloat(document.getElementById('valueT').value) || 0;
            const cosfi = parseFloat(document.getElementById('cosfi').value) || 0;
            const hoursYear = parseInt(document.getElementById('hoursYear').value) || 0;
            const voltageType = document.getElementById('voltageType').value;

            const average = calculateAverage(valueR, valueS, valueT);
            const voltageValueUsed = (voltageType === 'Trifase') ? 400 : 230;
            const power = calculatePower(average, cosfi, voltageType, voltageValueUsed);
            const energy = calculateEnergy(power, hoursYear);

            document.getElementById('average').value = average.toFixed(2);
            document.getElementById('power').value = power.toFixed(2);
            document.getElementById('energy').value = energy.toFixed(2);
        }

        function calculateAverage(r, s, t) {
            if (s === 0 && t === 0) { // Monofase
                return r;
            }
            return (r + s + t) / 3;
        }

        function calculatePower(average, cosfi, voltageType, voltageValue) {
            if (voltageType === 'Trifase') {
                return (Math.sqrt(3) * voltageValue * average * cosfi);
            } else { // Monofase / Bifase (assumendo monofase per il calcolo)
                return (voltageValue * average * cosfi);
            }
        }

        function calculateEnergy(power, hoursYear) {
            return (power * hoursYear) / 1000; // kWh
        }

function handleVoltageTypeChange() {
    const voltageType = document.getElementById('voltageType').value;
    const valueSInput = document.getElementById('valueS');
    const valueTInput = document.getElementById('valueT');

    switch (voltageType) {
        case 'Monofase':
            valueSInput.value = '0';
            valueTInput.value = '0';
            valueSInput.setAttribute('readonly', 'true');
            valueTInput.setAttribute('readonly', 'true');

// Aggiunge uno stile visivo per indicare che i campi sono disabilitati
        valueSInput.style.backgroundColor = '#f5f5f5';
        valueTInput.style.backgroundColor = '#f5f5f5';

            break;
        case 'Bifase':
            valueSInput.removeAttribute('readonly');
        valueSInput.style.backgroundColor = '';
            valueTInput.value = '0';
            valueTInput.setAttribute('readonly', 'true');
valueTInput.style.backgroundColor = '#f5f5f5';
            break;
        default: // Trifase
            valueSInput.removeAttribute('readonly');
            valueTInput.removeAttribute('readonly');
        valueSInput.style.backgroundColor = '';
        valueTInput.style.backgroundColor = '';
            break;
    }

    updateCalculations(); // Aggiorna i calcoli in base alle modifiche
}

        // Funzioni per l'upload e gestione foto
        document.getElementById('photoUpload').addEventListener('click', function() {
            document.getElementById('photoInput').click();
        });

        document.getElementById('photoInput').addEventListener('change', function(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const filesToProcess = Array.from(files).slice(0, 3 - photoFiles.length); // Max 3 foto in totale

            filesToProcess.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoFiles.push({ name: file.name, base64: e.target.result });
                    renderPhotoPreview();
                };
                reader.readAsDataURL(file);
            });
            event.target.value = ''; // Reset input file
        });

        function renderPhotoPreview() {
            const previewContainer = document.getElementById('photoPreview');
            previewContainer.innerHTML = ''; // Clear existing previews

            photoFiles.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                    <img src="${photo.base64}" alt="Anteprima Foto ${index + 1}">
                    <button type="button" class="photo-remove" data-index="${index}">X</button>
                `;
                previewContainer.appendChild(photoItem);
            });

            // Add event listeners for remove buttons
            previewContainer.querySelectorAll('.photo-remove').forEach(button => {
                button.addEventListener('click', function() {
                    const indexToRemove = parseInt(this.dataset.index);
                    photoFiles.splice(indexToRemove, 1);
                    renderPhotoPreview();
                });
            });
        }

        // Funzioni per suggerimenti autocomplete
        function setupAutocomplete(inputId, suggestionsBoxId, suggestionList) {
            const input = document.getElementById(inputId);
            const suggestionsBox = document.getElementById(suggestionsBoxId);

            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                suggestionsBox.innerHTML = '';
                suggestionsBox.style.display = 'none';

                if (query.length > 0) {
                    const filteredSuggestions = suggestionList.filter(item =>
                        item.toLowerCase().includes(query)
                    ).slice(0, 10); // Limita a 10 suggerimenti

                    if (filteredSuggestions.length > 0) {
                        filteredSuggestions.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggested-item';
                            div.textContent = item;
                            div.addEventListener('click', () => {
                                input.value = item;
                                suggestionsBox.style.display = 'none';
                                updateHierarchyDisplay(); // Aggiorna la gerarchia quando si seleziona un quadro/interruttore
                            });
                            suggestionsBox.appendChild(div);
                        });
                        suggestionsBox.style.display = 'block';
                    }
                }
            });

            input.addEventListener('blur', () => {
                // Ritarda la chiusura per permettere il click sul suggerimento
                setTimeout(() => {
                    suggestionsBox.style.display = 'none';
                }, 100);
            });

            input.addEventListener('focus', function() {
                // Mostra suggerimenti quando il campo √® focalizzato e non vuoto
                if (this.value.length > 0) {
                    const query = this.value.toLowerCase();
                    const filteredSuggestions = suggestionList.filter(item =>
                        item.toLowerCase().includes(query)
                    ).slice(0, 10);
                    if (filteredSuggestions.length > 0) {
                        suggestionsBox.style.display = 'block';
                    }
                }
            });
        }

        function setupEventListeners() {
            setupAutocomplete('quadroName', 'suggestedQuadri', quadroNames);
            setupAutocomplete('interruttore', 'suggestedInterruttori', interruttoreNames);

            document.getElementById('csvFileInput').addEventListener('change', processCSVFile);
            document.getElementById('photoInput').addEventListener('change', function(event) {
                const files = event.target.files;
                if (files.length === 0) return;

                const filesToProcess = Array.from(files).slice(0, 3 - photoFiles.length); // Max 3 foto in totale

                filesToProcess.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoFiles.push({ name: file.name, base64: e.target.result });
                        renderPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = ''; // Reset input file
            });
             document.getElementById('cancelEditBtn').addEventListener('click', resetForm);
             document.getElementById('podSelect').addEventListener('change', updateHierarchyDisplay);
             document.getElementById('quadroName').addEventListener('input', updateHierarchyDisplay);
             document.getElementById('interruttore').addEventListener('input', updateHierarchyDisplay);
        }

        // Funzione per mostrare la gerarchia dell'impianto
        function showHierarchy() {
    const treeContainer = document.getElementById('hierarchyTree');
    treeContainer.innerHTML = '';

    const hierarchyByPod = {};
    measurements.forEach(m => {
        if (!hierarchyByPod[m.pod]) hierarchyByPod[m.pod] = [];
        hierarchyByPod[m.pod].push(m);
    });

    for (const pod in hierarchyByPod) {
        const podDiv = document.createElement('div');
        podDiv.className = 'hierarchy-pod';
        podDiv.innerHTML = `<strong>${pod}</strong>`;

        const tree = {};

        hierarchyByPod[pod].forEach(measure => {
            const path = measure.hierarchyLevel.trim();
            if (!path) return;

            const levels = path.split('.');
            let current = tree;

            for (let i = 0; i < levels.length; i++) {
                const levelKey = levels.slice(0, i + 1).join('.');
                if (!current[levelKey]) {
                    current[levelKey] = {
                        children: {},
                        measure: (i === levels.length - 1) ? measure : null
                    };
                }
                current = current[levelKey].children;
            }
        });

        function sumDirectChildAmpere(subNodeMap) {
    let total = 0;
    for (const k in subNodeMap) {
        const subNode = subNodeMap[k];
        if (subNode.measure && !isNaN(parseFloat(subNode.measure.average))) {
            total += parseFloat(subNode.measure.average);
        }
        // NON includere i figli dei figli (nipoti)
    }
    return total;
}

        function renderNode(nodeMap, container, parentAmpere = null) {
    const sortedKeys = Object.keys(nodeMap).sort((a, b) => {
        const aParts = a.split('.').map(Number);
        const bParts = b.split('.').map(Number);
        for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
            const aVal = aParts[i] || 0;
            const bVal = bParts[i] || 0;
            if (aVal !== bVal) return aVal - bVal;
        }
        return 0;
    });

    sortedKeys.forEach(key => {
        const node = nodeMap[key];
        const div = document.createElement('div');
        div.className = 'hierarchy-quadro';

        let ampere = 0;
        if (node.measure && !isNaN(parseFloat(node.measure.average))) {
            ampere = parseFloat(node.measure.average);
        }

        const childrenSum = sumDirectChildAmpere(node.children);
        let statusIcon = '';
        if (parentAmpere !== null && ampere > parentAmpere) {
            statusIcon = ' ‚ö†Ô∏è';
        }
        if (ampere > 0 && childrenSum > ampere) {
            statusIcon = ' üî¥';
        }

        // ‚úÖ Etichetta migliorata con livello gerarchico completo
        let label = '';
if (node.measure && Object.keys(node.children).length === 0) {
    // Nodo foglia con misura
    label = `[${key}] ${node.measure.quadroName} (${node.measure.interruttore}) ‚Äî ${ampere} A`;
} else if (node.measure) {
    // Nodo con misura e figli
    label = `[${key}] ${node.measure.quadroName} (${node.measure.interruttore}) ‚Äî ${ampere} A, figli: ${childrenSum} A${statusIcon}`;
} else {
    // Nodo senza misura ma con figli
    label = `[${key}] ‚Äî figli: ${childrenSum} A${statusIcon}`;
}


        div.textContent = label;
        container.appendChild(div);

        if (Object.keys(node.children).length > 0) {
            renderNode(node.children, div, ampere);
        }
    });
}

        renderNode(tree, podDiv);
        treeContainer.appendChild(podDiv);
        const legendaDiv = document.createElement('div');
legendaDiv.className = 'hierarchy-legend';
legendaDiv.innerHTML = `
    <div><strong>Legenda:</strong></div>
    <ul style="list-style: none; padding-left: 10px;">
        <li>‚ö†Ô∏è Interruttore > nodo padre</li>
        <li>üî¥ Somma quadri/interruttori > nodo</li>
        <li>‚úÖ Nessun errore</li>
    </ul>
`;
treeContainer.appendChild(legendaDiv);
    }

    document.getElementById('hierarchyModal').style.display = 'flex';
}



        function hideHierarchy() {
            document.getElementById('hierarchyModal').style.display = 'none';
        }

        // Funzione per aggiornare la visualizzazione del livello gerarchico
        function updateHierarchyDisplay() {
            const pod = document.getElementById('podSelect').value;
            const quadro = document.getElementById('quadroName').value;
            const interruttore = document.getElementById('interruttore').value;
            const currentHierarchySpan = document.getElementById('currentHierarchy');

            if (pod && quadro && interruttore) {
                // Cerca la misura pi√π recente per il POD-Quadro-Interruttore selezionato
                const latestMeasure = measurements
                    .filter(m => m.pod === pod && m.quadroName === quadro && m.interruttore === interruttore)
                    .sort((a, b) => new Date(`${b.measureDate}T${b.measureTime}`) - new Date(`${a.measureDate}T${a.measureTime}`))
                    [0]; // Prendi la prima (pi√π recente)

                if (latestMeasure && latestMeasure.hierarchyLevel) {
                    currentHierarchySpan.textContent = `Livello: ${latestMeasure.hierarchyLevel}`;
                    document.getElementById('hierarchyLevel').value = latestMeasure.hierarchyLevel; // Prepopola il campo
                } else {
                    currentHierarchySpan.textContent = 'Livello: Non definito';
                    document.getElementById('hierarchyLevel').value = ''; // Pulisci il campo se non trovato
                }
            } else if (pod && quadro) {
                 // Mostra solo il quadro se l'interruttore non √® ancora selezionato
                currentHierarchySpan.textContent = `Livello: Quadro - ${quadro}`;
            }
             else if (pod) {
                currentHierarchySpan.textContent = `Livello: 0 (POD)`;
            } else {
                currentHierarchySpan.textContent = `Livello: Non definito`;
            }
        }

        // Funzione per mostrare notifiche temporanee
        let notificationTimeout;
function showNotification(message, type = '') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = 'notification' + (type ? ' ' + type : '');
    notification.textContent = message;

    container.appendChild(notification);

    // Mostra la notifica
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    // Nasconde e rimuove la notifica dopo 4 secondi
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            container.removeChild(notification);
        }, 500);
    }, 4000); // tempo di visibilit√† della notifica
}
// Carica le coordinate salvate al caricamento della pagina
function loadCoordinates() {
    podCoordinates = JSON.parse(localStorage.getItem('podCoordinates') || '[]');
    updateKMZButtonState();
}

// Aggiorna lo stato del pulsante KMZ
function updateKMZButtonState() {
    const kmzBtn = document.getElementById('generateKMZBtn');
    if (podCoordinates.length > 0) {
        kmzBtn.disabled = false;
        kmzBtn.textContent = `üó∫Ô∏è Genera KMZ (${podCoordinates.length} punti)`;
    } else {
        kmzBtn.disabled = true;
        kmzBtn.textContent = 'üó∫Ô∏è Genera KMZ';
    }
}

// Mostra la tabella delle coordinate
function showCoordinatesTable() {
    const tableBody = document.querySelector('#coordinatesTable tbody');
    tableBody.innerHTML = '';
        
    podCoordinates.forEach(coord => {
        const row = tableBody.insertRow();
        row.insertCell().textContent = coord.pod;
        row.insertCell().textContent = coord.denominazione;
        row.insertCell().textContent = coord.lat;
        row.insertCell().textContent = coord.lon;
        row.insertCell().textContent = coord.comune;
        row.insertCell().textContent = coord.indirizzo;
    });
        
    document.getElementById('coordinatesModal').style.display = 'flex';
}

// Nasconde la tabella delle coordinate
function hideCoordinatesTable() {
    document.getElementById('coordinatesModal').style.display = 'none';
}

// Genera e scarica il file KMZ
async function generateKMZ() {
    if (podCoordinates.length === 0) {
        showNotification('Nessuna coordinata disponibile per generare il KMZ.', 'error');
        return;
    }

    try {
        // Crea il contenuto KML
        const kmlContent = generateKMLContent();
                
        // Crea il file ZIP (KMZ √® un file ZIP con estensione .kmz)
        const zip = new JSZip();
        zip.file("doc.kml", kmlContent);
                
        // Genera il blob del file ZIP
        const kmzBlob = await zip.generateAsync({type: "blob"});
                
        // Crea il nome del file con timestamp
        const now = new Date();
        const timestamp = now.getFullYear() + 
                         String(now.getMonth() + 1).padStart(2, '0') + 
                         String(now.getDate()).padStart(2, '0') + '_' +
                         String(now.getHours()).padStart(2, '0') +
                         String(now.getMinutes()).padStart(2, '0');
                
        const fileName = `POD_Coordinates_${timestamp}.kmz`;

        // Crea il link per il download
        const link = document.createElement('a');
        link.href = URL.createObjectURL(kmzBlob);
        link.setAttribute('download', fileName);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
                
        showNotification(`File KMZ generato con successo: ${fileName} (${podCoordinates.length} punti)`);
            
    } catch (error) {
        console.error('Errore nella generazione del KMZ:', error);
        showNotification('Errore nella generazione del file KMZ: ' + error.message, 'error');
    }
}

// Genera il contenuto KML
function generateKMLContent() {
    let kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>POD Coordinates</name>
        <description>Coordinate dei Punti di Prelievo (POD) - Generato da Dashboard Misure Elettriche</description>
                
        <Style id="podStyle">
            <IconStyle>
                <color>ff0000ff</color>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/lightning.png</href>
                </Icon>
            </IconStyle>
            <LabelStyle>
                <color>ff0000ff</color>
                <scale>0.9</scale>
            </LabelStyle>
        </Style>
                
        <Folder>
            <name>Punti di Prelievo (POD)</name>
            <description>Tutti i POD con coordinate valide</description>`;

    // Aggiungi ogni punto POD
    podCoordinates.forEach(coord => {
        const description = createPODDescription(coord);
                
        kml += `            <Placemark>
                <name>${escapeXML(coord.pod)}</name>
                <description><![CDATA[${description}]]></description>
                <styleUrl>#podStyle</styleUrl>
                <Point>
                    <coordinates>${coord.lon},${coord.lat},0</coordinates>
                </Point>
            </Placemark>`;
    });

    kml += `        </Folder>
    </Document>
</kml>`;
    return kml;
}

// Crea la descrizione dettagliata per ogni POD
function createPODDescription(coord) {
    let description = `<div style="font-family: Arial, sans-serif; font-size: 12px;">`;
    description += `<h3 style="margin: 0; color: #d4af37;">POD: ${escapeHTML(coord.pod)}</h3>`;
    description += `<p><strong>Denominazione:</strong> ${escapeHTML(coord.denominazione)}</p>`;
    description += `<p><strong>Coordinate:</strong> ${coord.lat}, ${coord.lon}</p>`;

        
    if (coord.comune) {
        description += `<p><strong>Comune:</strong> ${escapeHTML(coord.comune)}</p>`;
    }
        
    if (coord.indirizzo) {
        description += `<p><strong>Indirizzo:</strong> ${escapeHTML(coord.indirizzo)}</p>`;
    }
        
    // Aggiungi informazioni sulle misure se disponibili
    const relatedMeasurements = measurements.filter(m => 
        m.pod === coord.combinedPod || m.pod === coord.pod
    );
        
    if (relatedMeasurements.length > 0) {
        description += `<hr><p><strong>Misure associate:</strong> ${relatedMeasurements.length}</p>`;
        description += `<p><strong>Ultima misura:</strong> ${relatedMeasurements[relatedMeasurements.length - 1].measureDate}</p>`;
    }
        
    description += `</div>`;
    return description;
}

// Utility functions per escape di caratteri speciali
function escapeXML(str) {
    return str.replace(/[<>&'"]/g, function(c) {
        switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case "'": return '&apos;';
            case '"': return '&quot;';
        }
    });
}

function escapeHTML(str) {
    return str.replace(/[<>&'"]/g, function(c) {
        switch (c) {
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '&': return '&amp;';
            case "'": return '&#039;';
            case '"': return '&quot;';
        }
    });
}
    </script>
</body>
</html>
